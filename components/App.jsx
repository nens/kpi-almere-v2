const logo = require('./logo.png');
const loadingIndicator = require('./loading.svg');
import { connect } from 'react-redux';
import React, { Component, PropTypes } from 'react';
import { Button, Grid, Row, Col, Label, Modal } from 'react-bootstrap';
import Pimap from './PiMap.jsx';
import PerformanceIndicatorList from './PerformanceIndicatorList.jsx';
import BoundaryTypeSelect from './BoundaryTypeSelect.jsx';
import NotificationSystem from 'react-notification-system';
import { defineMessages, FormattedMessage } from 'react-intl';

import {
  clearMapSelection,
  fetchApplicationBootstrap,
  fetchIndicatorsIfNeeded,
  fetchRegionsIfNeeded,
  fetchRegions,
  setZoomLevel,
  setRegion,
} from '../actions.jsx';

const messages = defineMessages({
  selected: {
    id: 'app.selected',
    defaultMessage: 'Selected',
  },
  apptitle: {
    id: 'app.apptitle',
    defaultMessage: 'Dashboard Performance Indicators',
  },
  infobutton: {
    id: 'app.infobutton',
    defaultMessage: 'Information',
  },
  infoModalClose: {
    id: 'app.infomodalclose',
    defaultMessage: 'Close',
  },
  infoModalBody: {
    id: 'app.infomodalbody',
    defaultMessage: 'Hier zit u het Dashboard Prestatie Indicatoren voor de waterbeheerder van gemeente Almere. Dit dashboard geeft inzicht in de prestaties van de operationele doelstellingen van de waterbeheerder.',
  },
  infoModalBody2: {
    id: 'app.infomodalbody2',
    defaultMessage: 'Door op een prestatie indicator te klikken, ziet u de trendlijn voor de ingesteld periode. In de titelbalk ziet u de actuele score. Op de kaart is de score per deelgebied, in kleur zichtbaar. De prestatie indicatoren zijn op drie schaalniveaus op te vragen; Gemeente, Wijk en Buurt.',
  },
  infoModalBody3: {
    id: 'app.infomodalbody3',
    defaultMessage: 'Klikt u in de titelbalk op het Lizard icoon naast de score, kunt u de onderliggende data inzien waaruit de prestatie indicatoren is opgebouwd.',
  },
  infoModalTitle: {
    id: 'app.infomodaltitle',
    defaultMessage: 'Information',
  },
});

class App extends Component {

  constructor(props) {
    super(props);
    this.state = {
      showInfo: false,
    };
    this._selectRegion = this._selectRegion.bind(this);
    this._selectZoomLevel = this._selectZoomLevel.bind(this);
    this.openInfo = this.openInfo.bind(this);
    this.closeInfo = this.closeInfo.bind(this);
    this.handleClearSelection = this.handleClearSelection.bind(this);
    this._addNotification = this._addNotification.bind(this);
    this._notificationSystem = null;
  }

  componentDidMount() {

    this._notificationSystem = this.refs.notificationSystem;
    this.props.dispatch(fetchIndicatorsIfNeeded());
    this.props.dispatch(fetchRegionsIfNeeded());
    this.props.dispatch(setRegion(
      JSON.parse('{"id":40098,"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[5.27116254173139,52.425423528452164,0],[5.274578915488101,52.42380637931666,0],[5.278375178644949,52.42243663597984,0],[5.3133223206661,52.41235441674015,0],[5.333798844026758,52.406105599388226,0],[5.336678913718437,52.40499420615401,0],[5.33900043371316,52.40389420117392,0],[5.341152983821651,52.40267005750054,0],[5.343357132802746,52.40115200185696,0],[5.344317921505963,52.401333900083614,0],[5.347693320542236,52.401045671800645,0],[5.349513500688256,52.40146777682089,0],[5.350772315630263,52.400209018656255,0],[5.349527090325937,52.39930089188357,0],[5.34816850968852,52.39702840953168,0],[5.346371014924039,52.396113775100126,0],[5.345913778678902,52.39645424419907,0],[5.344373128373386,52.39588389030739,0],[5.340108011419611,52.395940695595755,0],[5.338609828876674,52.395581490226924,0],[5.332370166166779,52.39324651128346,0],[5.332933410210378,52.39277312732003,0],[5.332604481879743,52.39265344244352,0],[5.313516407094165,52.385741600039346,0],[5.313039645296048,52.386252694120174,0],[5.303827068889853,52.38302723904196,0],[5.301244059047409,52.38198643466704,0],[5.316685757372366,52.368431692498376,0],[5.378993194877067,52.314445726402354,0],[5.37921178210249,52.3139945601882,0],[5.3540064031297705,52.30940739184019,0],[5.351500585484911,52.30923500068299,0],[5.348962322657931,52.30930251693755,0],[5.348617855269587,52.30916489406535,0],[5.348148442406164,52.3093822423845,0],[5.3441768649578165,52.31017178496638,0],[5.333504196707454,52.314273902257,0],[5.32022241350104,52.30535855810333,0],[5.3171721389211495,52.30356486334935,0],[5.304470547069283,52.309509302752694,0],[5.294352207541285,52.313690798983394,0],[5.284350104867265,52.31738031613363,0],[5.273371595919825,52.32096987911526,0],[5.262779003224942,52.32402122197459,0],[5.255423246336061,52.325886859645266,0],[5.245132281658016,52.32821069090166,0],[5.235098940107001,52.3301510389299,0],[5.223655999592164,52.332171131052334,0],[5.223445641689938,52.33192235871781,0],[5.2230295067462364,52.33198965723226,0],[5.221264767483187,52.33135899631298,0],[5.220498193349367,52.33080186237935,0],[5.2209160045226195,52.33168041780703,0],[5.220171422736211,52.33252739523337,0],[5.22042906998761,52.3328959096621,0],[5.22192994831848,52.33345446102414,0],[5.221344866937469,52.33336028104562,0],[5.2212276362742145,52.33348015583195,0],[5.220607610252944,52.33325810805243,0],[5.221196405708758,52.33351428309598,0],[5.220919040557589,52.33381744278652,0],[5.2201413668361125,52.33397040544816,0],[5.219348523609343,52.33370226114528,0],[5.219030001256757,52.333072386076594,0],[5.220144396110128,52.33188849233203,0],[5.219290004465378,52.33144126253217,0],[5.219062774912821,52.331056547107536,0],[5.219731767730593,52.330498499044104,0],[5.2166696539956305,52.32942457026514,0],[5.213633389545037,52.32984174221513,0],[5.213398990793232,52.329361736043545,0],[5.213297660773652,52.329378007703816,0],[5.213512336986051,52.32986303620818,0],[5.212662377436417,52.33005108431663,0],[5.212717433305463,52.33060435394672,0],[5.211685949146855,52.33097347491199,0],[5.211051719860504,52.33091571126961,0],[5.2096461521141775,52.33153128841672,0],[5.209544055161524,52.33186036745108,0],[5.20916114980942,52.33199713174021,0],[5.20856721886992,52.33255676298642,0],[5.206246066808418,52.333323518784276,0],[5.206101684074229,52.3334949532121,0],[5.205976000353143,52.334592998916996,0],[5.204769527032184,52.33551022236398,0],[5.200234019341043,52.336197164612805,0],[5.196510529003453,52.33647457095797,0],[5.192665130901901,52.33645200266205,0],[5.188299855628465,52.33605887388004,0],[5.179094319336343,52.33431923626327,0],[5.17895394919,52.33412988012756,0],[5.178420958736605,52.33402468454953,0],[5.178249779984283,52.33414780106712,0],[5.167143098695488,52.33192698446583,0],[5.156698596802501,52.32908201338772,0],[5.152957067094073,52.32912433415332,0],[5.152144406990957,52.32891809178945,0],[5.151157446128196,52.32795853587841,0],[5.151619603057504,52.32851273791235,0],[5.151268669511386,52.328903434199184,0],[5.150160961755148,52.32917706181671,0],[5.149130078530532,52.3291117735912,0],[5.147381822426303,52.32851776309644,0],[5.14646724271721,52.32775160345267,0],[5.146037528436238,52.32777658624397,0],[5.144803914561431,52.32707296446879,0],[5.144395958716977,52.32624460560223,0],[5.144409613475147,52.32561974167986,0],[5.145001066842677,52.32553123482519,0],[5.145019479330392,52.325371840005424,0],[5.145210360053876,52.32545838634934,0],[5.1442994460628775,52.324214413565194,0],[5.144722749478665,52.32392808907297,0],[5.1445824983023325,52.32386797063283,0],[5.142381525461795,52.325019389424995,0],[5.1401497362242745,52.32659293516304,0],[5.138514470855739,52.3257560530613,0],[5.138324362178502,52.32590171410353,0],[5.139964440688972,52.326729650839056,0],[5.137836384403488,52.328417903775346,0],[5.136956315897224,52.32935180751785,0],[5.137233091963815,52.32944333866731,0],[5.137677073409508,52.32897040554325,0],[5.138009050565721,52.32896631809153,0],[5.138322826270024,52.32873004510035,0],[5.138535885730067,52.3283427824178,0],[5.1392171612371085,52.328035484063534,0],[5.140295161062445,52.32801380442366,0],[5.141319587167443,52.328266153943794,0],[5.143611466250309,52.32963998556456,0],[5.144921613730281,52.33140256881358,0],[5.1449292211751505,52.33172391161738,0],[5.144130895555644,52.33220194697111,0],[5.143733758419021,52.332924116957905,0],[5.143071573615434,52.333322677446496,0],[5.140436482733195,52.33412626552363,0],[5.139073884719644,52.335044922752566,0],[5.137764578290417,52.336465188238606,0],[5.136887501051755,52.33704014720946,0],[5.135062384656048,52.337834971613084,0],[5.134482563734727,52.337973942760094,0],[5.134157966984083,52.337884756820856,0],[5.135190747282235,52.33858136474986,0],[5.136021587819476,52.33875304228867,0],[5.136116821505467,52.33896747420939,0],[5.135681235773749,52.33924727013777,0],[5.13410806815704,52.338401764331245,0],[5.132650812024657,52.337933231588565,0],[5.132873818840807,52.337739289765864,0],[5.132146753280267,52.337540617003974,0],[5.13218550808954,52.33709007694339,0],[5.130903789756977,52.33776693809827,0],[5.129951402501441,52.33780929828824,0],[5.129952721160516,52.33814149422723,0],[5.129172016251592,52.33866300296851,0],[5.129500755512749,52.339873467423786,0],[5.131206469529081,52.3419222291896,0],[5.130941657393353,52.34377418286792,0],[5.131256007994548,52.34346543592288,0],[5.132024029945355,52.34357825313584,0],[5.132147273131425,52.343699923941536,0],[5.131992585639915,52.34373597260812,0],[5.132573091946379,52.343924498305185,0],[5.132716433734862,52.3439119002433,0],[5.132248237334019,52.343732730645705,0],[5.133022544995606,52.34371260952748,0],[5.133107241709047,52.34384437957185,0],[5.132942510366532,52.3438559525174,0],[5.133350569163795,52.344005088504694,0],[5.133232398789257,52.34384501661865,0],[5.133860599597551,52.3438767722903,0],[5.133955745579709,52.343973633566236,0],[5.133348911646803,52.34426424391488,0],[5.1333058629137405,52.34455813770452,0],[5.133605670102497,52.344209043769794,0],[5.134132084050634,52.34473730496011,0],[5.133972922198977,52.34508670110068,0],[5.133650611933561,52.34527951539253,0],[5.133285730716173,52.34518660997507,0],[5.133320474580909,52.344897767454846,0],[5.133196441677962,52.344887363340725,0],[5.133186367487071,52.345201594946374,0],[5.13366424484789,52.3455391798295,0],[5.133621385305098,52.345802659857206,0],[5.133065522602568,52.346080237905255,0],[5.133039169106544,52.346348822163236,0],[5.133347223705689,52.34600481572549,0],[5.133743077539638,52.34622361432313,0],[5.1338738150554395,52.34650774204905,0],[5.133764508923689,52.34681669219696,0],[5.133433421373898,52.347002216055195,0],[5.133038970296202,52.34698352945401,0],[5.13302083115944,52.34666303592526,0],[5.132935812647075,52.34706328004633,0],[5.13355402129489,52.34745793248898,0],[5.134240352818658,52.34751762283858,0],[5.1317502001379705,52.36378936404806,0],[5.1313847253995615,52.365164417475285,0],[5.130142097909352,52.36701322921324,0],[5.123488052031104,52.37374824843586,0],[5.122527565607362,52.37507659457437,0],[5.122197933832412,52.37613311377432,0],[5.122158946305522,52.376892307776814,0],[5.122579987378232,52.378509371584315,0],[5.123211722825473,52.379470440399935,0],[5.124299395029274,52.38053796978938,0],[5.1256471987172345,52.38133187919157,0],[5.128195187362092,52.38239994517015,0],[5.128563293884731,52.38280148785258,0],[5.127236483518812,52.38429079201789,0],[5.128683462210057,52.38287556518299,0],[5.128941855995542,52.382886680213666,0],[5.141107195776684,52.38735228662374,0],[5.1398148816239715,52.38888925595412,0],[5.141386597630596,52.387463593550365,0],[5.1566634532570035,52.39307030520663,0],[5.1575468912370255,52.393862943649715,0],[5.161878404954117,52.39951315731097,0],[5.125446249689139,52.38618770520863,0],[5.121345427409979,52.38471800149274,0],[5.121233019941465,52.384786288480704,0],[5.16145176933152,52.39952288773215,0],[5.16160546153238,52.399802639087554,0],[5.16811605345847,52.402213736248896,0],[5.208095574822137,52.41681114322412,0],[5.208390062118387,52.416936136506955,0],[5.208242944031195,52.41719017089383,0],[5.208689152447713,52.417312812922304,0],[5.208911856219618,52.41712675628589,0],[5.210903710917563,52.417844384755604,0],[5.2108016101167305,52.418088180530546,0],[5.211146644816041,52.418221834150465,0],[5.211431148444761,52.41803328515748,0],[5.226683620071375,52.42359518931414,0],[5.2271780917237125,52.42361561209175,0],[5.227293958533288,52.42343023078197,0],[5.227176267744256,52.4233390288121,0],[5.208256258451061,52.416368032463225,0],[5.216968011070654,52.416433240199005,0],[5.220508690989157,52.41771812645299,0],[5.2200204059995405,52.41831269876899,0],[5.220171918355824,52.41836960541669,0],[5.222115058719328,52.41789989911589,0],[5.222920200786702,52.417255517477585,0],[5.222252030284466,52.41794616862909,0],[5.222423171504107,52.418009975138496,0],[5.222323733655691,52.41830960580061,0],[5.221776180668316,52.41897969663982,0],[5.2220120659588325,52.41901095146083,0],[5.222685939175432,52.4183693814282,0],[5.223952345674275,52.417795635535285,0],[5.224594869853208,52.41802586130106,0],[5.2244007991520025,52.41884933473839,0],[5.224571001959042,52.41917511235546,0],[5.228473928227682,52.42062947296843,0],[5.2327479662918,52.42531473777085,0],[5.2302192354238,52.42445074034533,0],[5.229840912479666,52.424532779964416,0],[5.229925841160608,52.42477761274324,0],[5.253723174712094,52.433467538643136,0],[5.258424253672872,52.43542550450104,0],[5.26658219754213,52.42840549619775,0],[5.268977396558722,52.426702984426996,0],[5.27116254173139,52.425423528452164,0]]]},"properties":{"name":"Almere","type":"MUNICIPALITY","area":373296142.8079373}}')
    ));
    // ^^ Not the right way to do this but needed for presentation purpose
    this.props.dispatch(fetchApplicationBootstrap());
  }

  componentWillReceiveProps(newProps) {
    if (newProps.indicators.errormessage) {
      this._addNotification(
        newProps.indicators.errormessage.message,
        newProps.indicators.errormessage.level
      );
    }
  }

  _addNotification(message, level) {
    this._notificationSystem.addNotification({
      message,
      level,
    });
  }

  handleClearSelection() {
    this.props.dispatch(clearMapSelection());
  }

  openInfo() {
    this.setState({ showInfo: true });
  }

  closeInfo() {
    this.setState({ showInfo: false });
  }

  _selectRegion(region) {
    this.props.dispatch(setRegion(region));
  }

  _selectZoomLevel(zoomlevel) {
    this.props.dispatch(setZoomLevel(zoomlevel));
    this.props.dispatch(fetchRegions(zoomlevel));
  }

  render() {
    return (
      <div>
      <Grid>
        <Row>
          <Col md={12}>
            <div
              style={{
                margin: '10px 0px 0 0',
              }}
              className='pull-right'>
              <Button
                onClick={this.openInfo}
                bsSize='xsmall'
                className='pull-right'>
                <i className='fa fa-info-circle'></i>&nbsp;<FormattedMessage {...messages.infobutton} />
              </Button>
            </div>
            <h3 style={{
              fontFamily: '"Lato", "sans-serif"',
              fontWeight: '100',
            }}><FormattedMessage {...messages.apptitle} />
            {(this.props.indicators.isFetching) ? <img src={loadingIndicator}/> : ''}
            </h3>
          </Col>
        </Row>
        <Row>
          <Col md={6}>
            <h4>
              <Label bsStyle='info'>
              <FormattedMessage {...messages.selected} />:&nbsp;&nbsp;
              {(this.props.indicators.region) ? `${this.props.indicators.region.properties.name}` : '---'}&nbsp;
              {(this.props.indicators.region) ? <i style={{ cursor: 'pointer' }} onClick={this.handleClearSelection} className='fa fa-times'></i>: ''}
              </Label>
            </h4>
          </Col>
          <Col md={6}>
            <BoundaryTypeSelect
              selectZoomLevel={this._selectZoomLevel}
              {...this.props}
            />
          </Col>
        </Row>
        <Row>
          <Col md={6}>
            <PerformanceIndicatorList
              {...this.props}
            />
          </Col>
          <Col md={6}>
            <Pimap
              selectRegion={this._selectRegion}
              {...this.props}
            />
          </Col>
        </Row>
      </Grid>

      <Modal
        show={this.state.showInfo}
        onHide={this.closeInfo}>
        <Modal.Header closeButton>
          <Modal.Title>
            <FormattedMessage {...messages.infoModalTitle} />
          </Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <FormattedMessage {...messages.infoModalBody} tagName='p' />
          <FormattedMessage {...messages.infoModalBody2} tagName='p' />
          <FormattedMessage {...messages.infoModalBody3} tagName='p' />
        </Modal.Body>
        <Modal.Footer>
          <Button onClick={this.closeInfo}><FormattedMessage {...messages.infoModalClose} /></Button>
        </Modal.Footer>
      </Modal>

      <NotificationSystem ref="notificationSystem" />
      </div>
    );
  }
}

App.propTypes = {
  data: PropTypes.object,
  dispatch: PropTypes.func,
  indicator: PropTypes.any,
  indicators: PropTypes.any,
  region: PropTypes.any,
  regions: PropTypes.any,
  username: PropTypes.string,
  zoomlevel: PropTypes.any,
  zoomlevels: PropTypes.any,
};

function mapStateToProps(state) {
  // This function maps the Redux state to React Props.
  return {
    'bootstrap': state.bootstrap,
    'indicators': state.indicators,
  };
}

export default connect(mapStateToProps)(App);
